#!/bin/bash
set -e

echo "ğŸ“¦ Installing essential packages for {{ .chezmoi.os }}..."

{{- if eq .chezmoi.os "darwin" }}
# macOS package installation with Homebrew
if ! command -v brew &> /dev/null; then
    echo "ğŸº Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    
    # Add Homebrew to PATH based on architecture
    if [[ $(uname -m) == "arm64" ]]; then
        echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> ~/.zprofile
        eval "$(/opt/homebrew/bin/brew shellenv)"
    else
        echo 'eval "$(/usr/local/bin/brew shellenv)"' >> ~/.zprofile
        eval "$(/usr/local/bin/brew shellenv)"
    fi
fi

# Update Homebrew
brew update

# Install uv first (Python package manager)
if ! command -v uv &> /dev/null; then
    echo "ğŸ Installing uv (Python package manager)..."
    curl -LsSf https://astral.sh/uv/install.sh | sh
    # Add uv to PATH for current session
    export PATH="$HOME/.cargo/bin:$PATH"
    # Also add to shell profile for future sessions
    if ! grep -q "export PATH.*cargo/bin" ~/.zprofile; then
        echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> ~/.zprofile
    fi
else
    echo "âœ… uv already installed"
fi

# Install Python via uv if not available
if ! command -v python3 &> /dev/null; then
    echo "ğŸ Installing Python via uv..."
    if command -v uv &> /dev/null; then
        uv python install 3.12
        # Add uv-managed Python to PATH
        export PATH="$HOME/.local/bin:$PATH"
        if ! grep -q "export PATH.*local/bin" ~/.zprofile; then
            echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.zprofile
        fi
    else
        echo "âš ï¸  uv not available, falling back to Homebrew Python..."
        brew install python@3.12
    fi
else
    echo "âœ… Python already available"
fi

# Install essential packages (excluding Python since we handle it above)
packages=(
    "git"
    "curl"
    "wget"
    "zsh"
    "fzf" 
    "vim"
    "neovim"
    "tree"
    "htop"
    "jq"
    "ripgrep"
    "fd"
    "bat"
    "eza"  # modern ls replacement
    "zoxide"
    "yazi"
    "tmux"
    "node"  # for npm packages
)

for package in "${packages[@]}"; do
    if ! brew list "$package" &> /dev/null; then
        echo "Installing $package..."
        brew install "$package"
    else
        echo "âœ… $package already installed"
    fi
done

# Install fzf key bindings and fuzzy completion
if [[ $(uname -m) == "arm64" ]]; then
    # Apple Silicon Mac
    if [[ -f "/opt/homebrew/opt/fzf/install" ]]; then
        /opt/homebrew/opt/fzf/install --key-bindings --completion --no-update-rc
    fi
else
    # Intel Mac
    if [[ -f "/usr/local/opt/fzf/install" ]]; then
        /usr/local/opt/fzf/install --key-bindings --completion --no-update-rc
    fi
fi

# Install global npm packages
if command -v npm &> /dev/null; then
    echo "ğŸ“¦ Installing global npm packages..."
    npm install -g @google/gemini-cli
fi

{{- else if (or (eq .chezmoi.os "linux") (eq .chezmoi.osRelease.id "ubuntu") (eq .chezmoi.osRelease.id "debian")) }}
# Debian/Ubuntu package installation
echo "ğŸ§ Installing packages for Debian/Ubuntu..."

# Check if we're running in WSL
if [[ -n "$WSL_DISTRO_NAME" ]]; then
    echo "ğŸš€ Detected WSL environment: $WSL_DISTRO_NAME"
fi

# Update package list
sudo apt update

# Install Rust and Cargo first (required for many tools)
if ! command -v cargo &> /dev/null; then
    echo "ğŸ¦€ Installing Rust and Cargo..."
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    source ~/.cargo/env
    
    # Add cargo to PATH for current session and future sessions
    export PATH="$HOME/.cargo/bin:$PATH"
    if ! grep -q "export PATH.*cargo/bin" ~/.zprofile; then
        echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> ~/.zprofile
    fi
    if ! grep -q "export PATH.*cargo/bin" ~/.bashrc; then
        echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> ~/.bashrc
    fi
    echo "âœ… Rust and Cargo installed successfully"
else
    echo "âœ… Rust and Cargo already installed"
    # Ensure cargo is in PATH
    export PATH="$HOME/.cargo/bin:$PATH"
fi

# Install uv (Python package manager) via cargo
if ! command -v uv &> /dev/null; then
    echo "ğŸ Installing uv (Python package manager)..."
    if command -v cargo &> /dev/null; then
        cargo install uv
        # Add uv to PATH for current session
        export PATH="$HOME/.cargo/bin:$PATH"
        # Also add to shell profile for future sessions
        if ! grep -q "export PATH.*cargo/bin" ~/.zprofile; then
            echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> ~/.zprofile
        fi
    else
        echo "âš ï¸  Cargo not available, falling back to curl installation..."
        curl -LsSf https://astral.sh/uv/install.sh | sh
        export PATH="$HOME/.cargo/bin:$PATH"
    fi
else
    echo "âœ… uv already installed"
fi

# Install Python via uv if not available
if ! command -v python3 &> /dev/null; then
    echo "ğŸ Installing Python via uv..."
    if command -v uv &> /dev/null; then
        uv python install 3.12
        # Add uv-managed Python to PATH
        export PATH="$HOME/.local/bin:$PATH"
        if ! grep -q "export PATH.*local/bin" ~/.zprofile; then
            echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.zprofile
        fi
    else
        echo "âš ï¸  uv not available, falling back to system Python..."
        sudo apt install -y python3 python3-pip
    fi
else
    echo "âœ… Python already available"
fi

# Install newer Neovim (0.8+) for lazy.nvim compatibility
if ! command -v nvim &> /dev/null || ! nvim --version | grep -q "NVIM v0\.[89]\|NVIM v[1-9]"; then
    echo "ğŸ“ Installing newer Neovim (0.8+) for lazy.nvim compatibility..."
    
    # Remove old version if present
    if command -v nvim &> /dev/null; then
        echo "Removing old Neovim version..."
        sudo apt remove -y neovim
    fi
    
    # Add Neovim PPA for latest stable version
    if ! grep -q "neovim-ppa" /etc/apt/sources.list.d/*; then
        echo "Adding Neovim PPA..."
        sudo add-apt-repository ppa:neovim-ppa/stable -y
        sudo apt update
    fi
    
    # Install Neovim
    sudo apt install -y neovim
    
    # Verify version
    if command -v nvim &> /dev/null; then
        nvim_version=$(nvim --version | head -n1)
        echo "âœ… Neovim installed: $nvim_version"
    else
        echo "âŒ Neovim installation failed"
        exit 1
    fi
else
    echo "âœ… Neovim 0.8+ already installed"
fi

# Install essential packages (excluding Python and Neovim since we handle them above)
packages=(
    "git" 
    "curl"
    "wget"
    "zsh"
    "fzf"
    "vim"
    "tree"
    "htop"
    "jq"
    "ripgrep"
    "fd-find"
    "bat"
    "tmux"
    "build-essential"
    "nodejs"
    "npm"
    "ca-certificates"  # Important for WSL
    "gnupg"            # For adding PPAs
    "software-properties-common"  # For add-apt-repository
)

for package in "${packages[@]}"; do
    if ! dpkg -l | grep -q "^ii  $package "; then
        echo "Installing $package..."
        sudo apt install -y "$package"
    else
        echo "âœ… $package already installed"
    fi
done

# Install eza (not in standard repos)
if ! command -v eza &> /dev/null; then
    echo "ğŸ“¦ Installing eza..."
    if command -v cargo &> /dev/null; then
        cargo install eza
    else
        # Fallback to binary download
        wget -c https://github.com/eza-community/eza/releases/latest/download/eza_x86_64-unknown-linux-gnu.tar.gz -O - | tar xz
        sudo mv eza /usr/local/bin/
    fi
fi

# Install zoxide
if ! command -v zoxide &> /dev/null; then
    echo "ğŸ“¦ Installing zoxide..."
    if command -v cargo &> /dev/null; then
        cargo install zoxide
    else
        # Fallback to curl installation
        curl -sS https://raw.githubusercontent.com/ajeetdsouza/zoxide/main/install.sh | bash
    fi
fi

# Install yazi  
if ! command -v yazi &> /dev/null; then
    echo "ğŸ“¦ Installing yazi..."
    if command -v cargo &> /dev/null; then
        cargo install --locked yazi-fm yazi-cli
    else
        echo "âš ï¸  Cargo not available, skipping yazi installation"
    fi
fi

# Create symlinks for fd and bat (they have different names on Ubuntu)
if command -v fdfind &> /dev/null && ! command -v fd &> /dev/null; then
    sudo ln -sf $(which fdfind) /usr/local/bin/fd
fi

if command -v batcat &> /dev/null && ! command -v bat &> /dev/null; then
    sudo ln -sf $(which batcat) /usr/local/bin/bat
fi

# Install global npm packages
if command -v npm &> /dev/null; then
    echo "ğŸ“¦ Installing global npm packages..."
    npm install -g @google/gemini-cli
fi

# WSL-specific fixes
if [[ -n "$WSL_DISTRO_NAME" ]]; then
    echo "ğŸ”§ Applying WSL-specific fixes..."
    
    # Fix potential zsh completion issues by ensuring completions directory exists
    sudo mkdir -p /usr/share/zsh/vendor-completions
    
    # Install Docker completions if Docker is available
    if command -v docker &> /dev/null; then
        echo "ğŸ³ Docker found, ensuring completions are available..."
        if [[ ! -f /usr/share/zsh/vendor-completions/_docker ]]; then
            echo "Installing Docker zsh completions..."
            sudo curl -L https://raw.githubusercontent.com/docker/cli/master/contrib/completion/zsh/_docker -o /usr/share/zsh/vendor-completions/_docker
        fi
    else
        echo "ğŸ³ Docker not found - install with: sudo apt install docker.io"
    fi
    
    # Ensure proper permissions for zsh completions
    sudo chmod 644 /usr/share/zsh/vendor-completions/* 2>/dev/null || true
fi

{{- end }}

echo "âœ… Package installation complete!"

# Final verification
echo "ğŸ” Verifying key installations..."
if command -v cargo &> /dev/null; then
    echo "âœ… Cargo: $(cargo --version)"
else
    echo "âŒ Cargo not found"
fi

if command -v nvim &> /dev/null; then
    echo "âœ… Neovim: $(nvim --version | head -n1)"
else
    echo "âŒ Neovim not found"
fi

if command -v zsh &> /dev/null; then
    echo "âœ… Zsh: $(zsh --version)"
else
    echo "âŒ Zsh not found"
fi

echo "ğŸ’¡ If you encounter any issues, try: source ~/.zprofile"
echo "ğŸ’¡ For WSL users: You may need to restart your terminal or run 'exec zsh'"
