#!/bin/bash
set -e

echo "📦 Installing essential packages for {{ .chezmoi.os }}..."

{{- if eq .chezmoi.os "darwin" }}
# macOS package installation with Homebrew
if ! command -v brew &> /dev/null; then
    echo "🍺 Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    
    # Add Homebrew to PATH based on architecture
    if [[ $(uname -m) == "arm64" ]]; then
        echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> ~/.zprofile
        eval "$(/opt/homebrew/bin/brew shellenv)"
    else
        echo 'eval "$(/usr/local/bin/brew shellenv)"' >> ~/.zprofile
        eval "$(/usr/local/bin/brew shellenv)"
    fi
fi

# Update Homebrew
brew update

# Install uv first (Python package manager)
if ! command -v uv &> /dev/null; then
    echo "🐍 Installing uv (Python package manager)..."
    curl -LsSf https://astral.sh/uv/install.sh | sh
    # Add uv to PATH for current session
    export PATH="$HOME/.cargo/bin:$PATH"
    # Also add to shell profile for future sessions
    if ! grep -q "export PATH.*cargo/bin" ~/.zprofile; then
        echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> ~/.zprofile
    fi
else
    echo "✅ uv already installed"
fi

# Install Python via uv if not available
if ! command -v python3 &> /dev/null; then
    echo "🐍 Installing Python via uv..."
    if command -v uv &> /dev/null; then
        uv python install 3.12
        # Add uv-managed Python to PATH
        export PATH="$HOME/.local/bin:$PATH"
        if ! grep -q "export PATH.*local/bin" ~/.zprofile; then
            echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.zprofile
        fi
    else
        echo "⚠️  uv not available, falling back to Homebrew Python..."
        brew install python@3.12
    fi
else
    echo "✅ Python already available"
fi

# Install essential packages (excluding Python since we handle it above)
packages=(
    "git"
    "curl"
    "wget"
    "zsh"
    "fzf" 
    "vim"
    "neovim"
    "tree"
    "htop"
    "jq"
    "ripgrep"
    "fd"
    "bat"
    "eza"  # modern ls replacement
    "zoxide"
    "yazi"
    "tmux"
    "node"  # for npm packages
)

for package in "${packages[@]}"; do
    if ! brew list "$package" &> /dev/null; then
        echo "Installing $package..."
        brew install "$package"
    else
        echo "✅ $package already installed"
    fi
done

# Install fzf key bindings and fuzzy completion
if [[ $(uname -m) == "arm64" ]]; then
    # Apple Silicon Mac
    if [[ -f "/opt/homebrew/opt/fzf/install" ]]; then
        /opt/homebrew/opt/fzf/install --key-bindings --completion --no-update-rc
    fi
else
    # Intel Mac
    if [[ -f "/usr/local/opt/fzf/install" ]]; then
        /usr/local/opt/fzf/install --key-bindings --completion --no-update-rc
    fi
fi

# Install global npm packages
if command -v npm &> /dev/null; then
    echo "📦 Installing global npm packages..."
    npm install -g @google/gemini-cli
fi

{{- else if (or (eq .chezmoi.os "linux") (eq .chezmoi.osRelease.id "ubuntu") (eq .chezmoi.osRelease.id "debian")) }}
# Debian/Ubuntu package installation
echo "🐧 Installing packages for Debian/Ubuntu..."

# Update package list
sudo apt update

# Install uv first (Python package manager)
if ! command -v uv &> /dev/null; then
    echo "🐍 Installing uv (Python package manager)..."
    curl -LsSf https://astral.sh/uv/install.sh | sh
    # Add uv to PATH for current session
    export PATH="$HOME/.cargo/bin:$PATH"
    # Also add to shell profile for future sessions
    if ! grep -q "export PATH.*cargo/bin" ~/.zprofile; then
        echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> ~/.zprofile
    fi
else
    echo "✅ uv already installed"
fi

# Install Python via uv if not available
if ! command -v python3 &> /dev/null; then
    echo "🐍 Installing Python via uv..."
    if command -v uv &> /dev/null; then
        uv python install 3.12
        # Add uv-managed Python to PATH
        export PATH="$HOME/.local/bin:$PATH"
        if ! grep -q "export PATH.*local/bin" ~/.zprofile; then
            echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.zprofile
        fi
    else
        echo "⚠️  uv not available, falling back to system Python..."
        sudo apt install -y python3 python3-pip
    fi
else
    echo "✅ Python already available"
fi

# Install essential packages (excluding Python since we handle it above)
packages=(
    "git" 
    "curl"
    "wget"
    "zsh"
    "fzf"
    "vim"
    "neovim"
    "tree"
    "htop"
    "jq"
    "ripgrep"
    "fd-find"
    "bat"
    "tmux"
    "build-essential"
    "nodejs"
    "npm"
)

for package in "${packages[@]}"; do
    if ! dpkg -l | grep -q "^ii  $package "; then
        echo "Installing $package..."
        sudo apt install -y "$package"
    else
        echo "✅ $package already installed"
    fi
done

# Install eza (not in standard repos)
if ! command -v eza &> /dev/null; then
    echo "📦 Installing eza..."
    wget -c https://github.com/eza-community/eza/releases/latest/download/eza_x86_64-unknown-linux-gnu.tar.gz -O - | tar xz
    sudo mv eza /usr/local/bin/
fi

# Install zoxide
if ! command -v zoxide &> /dev/null; then
    echo "📦 Installing zoxide..."
    curl -sS https://raw.githubusercontent.com/ajeetdsouza/zoxide/main/install.sh | bash
fi

# Install yazi  
if ! command -v yazi &> /dev/null; then
    echo "📦 Installing yazi..."
    cargo install --locked yazi-fm yazi-cli
fi

# Create symlinks for fd and bat (they have different names on Ubuntu)
if command -v fdfind &> /dev/null && ! command -v fd &> /dev/null; then
    sudo ln -sf $(which fdfind) /usr/local/bin/fd
fi

if command -v batcat &> /dev/null && ! command -v bat &> /dev/null; then
    sudo ln -sf $(which batcat) /usr/local/bin/bat
fi

# Install global npm packages
if command -v npm &> /dev/null; then
    echo "📦 Installing global npm packages..."
    npm install -g @google/gemini-cli
fi

{{- end }}

echo "✅ Package installation complete!"
