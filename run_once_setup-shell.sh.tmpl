#!/bin/bash
set -e

echo "🐚 Setting up Zsh and Oh-my-zsh..."

# Install Oh-my-zsh if not present
if [[ ! -d "$HOME/.oh-my-zsh" ]]; then
    echo "📦 Installing Oh-my-zsh..."
    # Use a more reliable installation method
    RUNZSH=no CHSH=no sh -c "$(curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
    
    # Verify installation
    if [[ -d "$HOME/.oh-my-zsh" ]]; then
        echo "✅ Oh-my-zsh installed successfully"
    else
        echo "❌ Oh-my-zsh installation failed"
        exit 1
    fi
else
    echo "✅ Oh-my-zsh already installed"
fi

# Install zsh-history-substring-search plugin
ZSH_CUSTOM="${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}"
if [[ ! -d "$ZSH_CUSTOM/plugins/zsh-history-substring-search" ]]; then
    echo "📦 Installing zsh-history-substring-search plugin..."
    git clone https://github.com/zsh-users/zsh-history-substring-search "$ZSH_CUSTOM/plugins/zsh-history-substring-search"
else
    echo "✅ zsh-history-substring-search already installed"
fi

# Set zsh as default shell if not already
if [[ "$SHELL" != "{{ .shell }}" ]]; then
    echo "🔄 Setting zsh as default shell..."
    # Add zsh to allowed shells if not already there
    if ! grep -q "{{ .shell }}" /etc/shells; then
        echo "{{ .shell }}" | sudo tee -a /etc/shells
    fi
    chsh -s {{ .shell }}
    echo "✅ Default shell changed to zsh (will take effect on next login)"
else
    echo "✅ Zsh is already the default shell"
fi

{{- if eq .chezmoi.os "darwin" }}
# macOS: Set up fzf integration based on architecture
if [[ $(uname -m) == "arm64" ]]; then
    # Apple Silicon Mac
    if [[ -f "/opt/homebrew/opt/fzf/install" ]] && [[ ! -f "$HOME/.fzf.zsh" ]]; then
        echo "🔍 Setting up fzf integration..."
        /opt/homebrew/opt/fzf/install --key-bindings --completion --no-update-rc
    fi
else
    # Intel Mac
    if [[ -f "/usr/local/opt/fzf/install" ]] && [[ ! -f "$HOME/.fzf.zsh" ]]; then
        echo "🔍 Setting up fzf integration..."
        /usr/local/opt/fzf/install --key-bindings --completion --no-update-rc
    fi
fi
{{- else }}
# Linux: fzf should already be configured via package installation
echo "✅ fzf integration configured via package manager"
{{- end }}

echo "✅ Shell setup complete!"

# Final verification
if [[ -f "$HOME/.zshrc" ]]; then
    echo "✅ .zshrc file found"
else
    echo "❌ .zshrc file not found - this may cause issues"
fi

if [[ -d "$HOME/.oh-my-zsh" ]]; then
    echo "✅ Oh-my-zsh directory confirmed"
else
    echo "❌ Oh-my-zsh directory missing - installation may have failed"
fi

echo "💡 Run 'exec zsh' to start using your new configuration"
echo "💡 If you still get errors, try: source ~/.zshrc"
