#!/bin/bash
set -e

echo "üêö Setting up Zsh and Oh-my-zsh..."

# Check if we're running in WSL
if [[ -n "$WSL_DISTRO_NAME" ]]; then
    echo "üöÄ Detected WSL environment: $WSL_DISTRO_NAME"
    echo "üîß Applying WSL-specific shell fixes..."
    
    # Ensure zsh completions directory exists and has proper permissions
    sudo mkdir -p /usr/share/zsh/vendor-completions
    sudo chmod 755 /usr/share/zsh/vendor-completions
    
    # Fix potential Docker completion file issues
    docker_completion="/usr/share/zsh/vendor-completions/_docker"
    if [[ -e "$docker_completion" ]]; then
        # Check if it's empty, broken symlink, or points to WSL mount that may not be available
        if [[ ! -s "$docker_completion" ]] || [[ -L "$docker_completion" && ! -r "$docker_completion" ]]; then
            echo "üîß Fixing broken Docker completion file (empty or broken symlink)..."
            sudo rm -f "$docker_completion"
        elif [[ -L "$docker_completion" ]]; then
            # If it's a symlink to WSL Docker Desktop, that's fine but may cause startup warnings
            link_target=$(readlink "$docker_completion")
            if [[ "$link_target" == *"/mnt/wsl/docker-desktop"* ]]; then
                echo "üìù Docker completion is symlinked to Docker Desktop (may cause startup warnings)"
            fi
        fi
    fi
    
    # Install Docker completions if Docker is available and completion is missing/broken
    if command -v docker &> /dev/null && [[ ! -s "$docker_completion" ]]; then
        echo "üê≥ Installing Docker zsh completions..."
        # Ensure the directory exists before trying to write to it
        sudo mkdir -p "$(dirname "$docker_completion")"
        sudo curl -L https://raw.githubusercontent.com/docker/cli/master/contrib/completion/zsh/_docker -o "$docker_completion"
        sudo chmod 644 "$docker_completion"
    fi
fi

# Install Oh-my-zsh if not present
if [[ ! -d "$HOME/.oh-my-zsh" ]]; then
    echo "üì¶ Installing Oh-my-zsh..."
    # Use a more reliable installation method
    RUNZSH=no CHSH=no sh -c "$(curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
    
    # Verify installation
    if [[ -d "$HOME/.oh-my-zsh" ]]; then
        echo "‚úÖ Oh-my-zsh installed successfully"
    else
        echo "‚ùå Oh-my-zsh installation failed"
        exit 1
    fi
else
    echo "‚úÖ Oh-my-zsh already installed"
fi

# Install zsh-history-substring-search plugin
ZSH_CUSTOM="${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}"
if [[ ! -d "$ZSH_CUSTOM/plugins/zsh-history-substring-search" ]]; then
    echo "üì¶ Installing zsh-history-substring-search plugin..."
    
    # Ensure the plugins directory exists
    mkdir -p "$ZSH_CUSTOM/plugins"
    
    # Try to clone the plugin with better error handling
    if git clone https://github.com/zsh-users/zsh-history-substring-search "$ZSH_CUSTOM/plugins/zsh-history-substring-search" 2>/dev/null; then
        echo "‚úÖ zsh-history-substring-search plugin installed successfully"
    else
        echo "‚ö†Ô∏è  Git clone failed, trying alternative methods..."
        
        # Try with git protocol fallback
        if git clone git://github.com/zsh-users/zsh-history-substring-search.git "$ZSH_CUSTOM/plugins/zsh-history-substring-search" 2>/dev/null; then
            echo "‚úÖ zsh-history-substring-search plugin installed via git protocol"
        else
            echo "‚ùå Git clone failed. This might be a network/WSL issue."
            echo "üí° Trying to download as zip file..."
            
            # Fallback to zip download
            if command -v curl &> /dev/null; then
                cd "$ZSH_CUSTOM/plugins"
                if curl -L -o zsh-history-substring-search.zip https://github.com/zsh-users/zsh-history-substring-search/archive/refs/heads/master.zip; then
                    unzip -q zsh-history-substring-search.zip
                    mv zsh-history-substring-search-master zsh-history-substring-search
                    rm zsh-history-substring-search.zip
                    echo "‚úÖ zsh-history-substring-search plugin installed via zip download"
                else
                    echo "‚ùå Zip download also failed. Manual installation required:"
                    echo "   cd $ZSH_CUSTOM/plugins"
                    echo "   git clone https://github.com/zsh-users/zsh-history-substring-search"
                fi
            else
                echo "‚ùå Neither git nor curl available. Manual installation required:"
                echo "   cd $ZSH_CUSTOM/plugins"
                echo "   git clone https://github.com/zsh-users/zsh-history-substring-search"
            fi
        fi
    fi
else
    echo "‚úÖ zsh-history-substring-search already installed"
fi

# Verify the plugin installation
if [[ -d "$ZSH_CUSTOM/plugins/zsh-history-substring-search" ]]; then
    if [[ -f "$ZSH_CUSTOM/plugins/zsh-history-substring-search/zsh-history-substring-search.zsh" ]]; then
        echo "‚úÖ Plugin files verified"
    else
        echo "‚ö†Ô∏è  Plugin directory exists but main file missing - removing and retrying..."
        rm -rf "$ZSH_CUSTOM/plugins/zsh-history-substring-search"
        echo "Please run this script again to reinstall the plugin"
    fi
else
    echo "‚ùå Plugin installation failed - check network connectivity and try again"
fi

# Set zsh as default shell if not already
ZSH_PATH=$(which zsh)
if [[ "$SHELL" != "$ZSH_PATH" ]]; then
    echo "üîÑ Setting zsh as default shell..."
    # Add zsh to allowed shells if not already there
    if ! grep -q "$ZSH_PATH" /etc/shells; then
        echo "$ZSH_PATH" | sudo tee -a /etc/shells
    fi
    chsh -s "$ZSH_PATH"
    echo "‚úÖ Default shell changed to zsh (will take effect on next login)"
else
    echo "‚úÖ Zsh is already the default shell"
fi

{{- if eq .chezmoi.os "darwin" }}
# macOS: Set up fzf integration and fix common completion issues
echo "üçé Setting up macOS-specific zsh completions..."

# Ensure Homebrew completions are properly linked
if command -v brew &> /dev/null; then
    echo "üîß Setting up Homebrew completions..."
    
    # Create Homebrew completions directory if it doesn't exist
    mkdir -p "$HOME/.zsh/completions"
    
    # Link Homebrew completions
    if [[ -d "/opt/homebrew/share/zsh/site-functions" ]]; then
        # Apple Silicon Mac
        if [[ ! -L "$HOME/.zsh/completions/_brew" ]]; then
            ln -sf "/opt/homebrew/share/zsh/site-functions/_brew" "$HOME/.zsh/completions/_brew"
        fi
        # Link other common Homebrew completions
        for completion in /opt/homebrew/share/zsh/site-functions/_*; do
            if [[ -f "$completion" ]]; then
                basename=$(basename "$completion")
                if [[ ! -L "$HOME/.zsh/completions/$basename" ]]; then
                    ln -sf "$completion" "$HOME/.zsh/completions/$basename"
                fi
            fi
        done
    elif [[ -d "/usr/local/share/zsh/site-functions" ]]; then
        # Intel Mac
        if [[ ! -L "$HOME/.zsh/completions/_brew" ]]; then
            ln -sf "/usr/local/share/zsh/site-functions/_brew" "$HOME/.zsh/completions/_brew"
        fi
        # Link other common Homebrew completions
        for completion in /usr/local/share/zsh/site-functions/_*; do
            if [[ -f "$completion" ]]; then
                basename=$(basename "$completion")
                if [[ ! -L "$HOME/.zsh/completions/$basename" ]]; then
                    ln -sf "$completion" "$HOME/.zsh/completions/$basename"
                fi
            fi
        done
    fi
    
    echo "‚úÖ Homebrew completions linked"
fi

# Set up fzf integration based on architecture
if [[ $(uname -m) == "arm64" ]]; then
    # Apple Silicon Mac
    if [[ -f "/opt/homebrew/opt/fzf/install" ]] && [[ ! -f "$HOME/.fzf.zsh" ]]; then
        echo "üîç Setting up fzf integration..."
        /opt/homebrew/opt/fzf/install --key-bindings --completion --no-update-rc
    fi
else
    # Intel Mac
    if [[ -f "/usr/local/opt/fzf/install" ]] && [[ ! -f "$HOME/.fzf.zsh" ]]; then
        echo "üîç Setting up fzf integration..."
        /usr/local/opt/fzf/install --key-bindings --completion --no-update-rc
    fi
fi

# Create macOS-specific safe compinit configuration
if [[ ! -f "$HOME/.zshrc.macos" ]]; then
    cat > "$HOME/.zshrc.macos" << 'EOF'
# macOS-specific zsh completions fix
# This ensures completions work properly on macOS

# Add Homebrew completions to fpath
if [[ -d "$HOME/.zsh/completions" ]]; then
    fpath=("$HOME/.zsh/completions" $fpath)
fi

# Add Homebrew completions to fpath based on architecture
if [[ $(uname -m) == "arm64" ]]; then
    # Apple Silicon Mac
    if [[ -d "/opt/homebrew/share/zsh/site-functions" ]]; then
        fpath=("/opt/homebrew/share/zsh/site-functions" $fpath)
    fi
else
    # Intel Mac
    if [[ -d "/usr/local/share/zsh/site-functions" ]]; then
        fpath=("/usr/local/share/zsh/site-functions" $fpath)
    fi
fi

# Safe compinit function for macOS
safe_compinit() {
    # Ensure fpath is properly set
    if [[ -d "$HOME/.zsh/completions" ]]; then
        fpath=("$HOME/.zsh/completions" $fpath)
    fi
    
    # Load completions with error handling
    compinit -i  # Ignore insecure files
}

# Override compinit with safe version
autoload -Uz safe_compinit
safe_compinit
EOF
    echo "‚úÖ Created macOS-specific safe compinit configuration"
fi

# Ensure .zshrc loads the macOS config
if [[ -f "$HOME/.zshrc" ]] && ! grep -q "source.*zshrc.macos" "$HOME/.zshrc"; then
    echo "source ~/.zshrc.macos" >> "$HOME/.zshrc"
    echo "‚úÖ Added macOS zshrc to main .zshrc"
fi

# Fix common macOS completion permission issues
echo "üîß Fixing completion permissions..."
if [[ -d "$HOME/.zsh/completions" ]]; then
    chmod 644 "$HOME/.zsh/completions"/* 2>/dev/null || true
fi

# Ensure system completions are accessible
if [[ -d "/usr/share/zsh/completions" ]]; then
    sudo chmod 755 /usr/share/zsh/completions
    sudo chmod 644 /usr/share/zsh/completions/* 2>/dev/null || true
fi

{{- else }}
# Linux: fzf should already be configured via package installation
echo "‚úÖ fzf integration configured via package manager"
{{- end }}

# WSL-specific zsh completion fixes
if [[ -n "$WSL_DISTRO_NAME" ]]; then
    echo "üîß Setting up WSL-specific zsh completions..."
    
    # Create a safe compinit configuration that won't fail on missing files
    if [[ ! -f "$HOME/.zshrc.local" ]]; then
        cat > "$HOME/.zshrc.local" << 'EOF'
# WSL-specific zsh completions fix
# This prevents compinit errors from missing completion files

# Safe compinit function
safe_compinit() {
    # Only load completions if the directory exists and has files
    if [[ -d /usr/share/zsh/vendor-completions ]] && [[ -n "$(ls -A /usr/share/zsh/vendor-completions 2>/dev/null)" ]]; then
        compinit
    else
        compinit -i  # Ignore insecure files
    fi
}

# Override compinit with safe version
autoload -Uz safe_compinit
safe_compinit
EOF
        echo "‚úÖ Created safe compinit configuration"
    fi
    
    # Ensure .zshrc loads the local config
    if [[ -f "$HOME/.zshrc" ]] && ! grep -q "source.*zshrc.local" "$HOME/.zshrc"; then
        echo "source ~/.zshrc.local" >> "$HOME/.zshrc"
        echo "‚úÖ Added local zshrc to main .zshrc"
    fi
fi

echo "‚úÖ Shell setup complete!"

# Final verification
if [[ -f "$HOME/.zshrc" ]]; then
    echo "‚úÖ .zshrc file found"
else
    echo "‚ùå .zshrc file not found - this may cause issues"
fi

if [[ -d "$HOME/.oh-my-zsh" ]]; then
    echo "‚úÖ Oh-my-zsh directory confirmed"
else
    echo "‚ùå Oh-my-zsh directory missing - installation may have failed"
fi

# WSL-specific final checks
if [[ -n "$WSL_DISTRO_NAME" ]]; then
    echo "üîç WSL-specific verification..."
    
    if [[ -d /usr/share/zsh/vendor-completions ]]; then
        echo "‚úÖ Zsh completions directory exists"
        completion_count=$(ls -1 /usr/share/zsh/vendor-completions/* 2>/dev/null | wc -l)
        echo "   Found $completion_count completion files"
    else
        echo "‚ùå Zsh completions directory missing"
    fi
    
    if [[ -f "$HOME/.zshrc.local" ]]; then
        echo "‚úÖ Safe compinit configuration created"
    else
        echo "‚ùå Safe compinit configuration missing"
    fi
fi

# macOS-specific final checks
{{- if eq .chezmoi.os "darwin" }}
echo "üçé macOS-specific verification..."
if [[ -d "$HOME/.zsh/completions" ]]; then
    echo "‚úÖ Homebrew completions directory exists"
    completion_count=$(ls -1 "$HOME/.zsh/completions"/* 2>/dev/null | wc -l)
    echo "   Found $completion_count Homebrew completion files"
    
    # Check for specific important completions
    if [[ -L "$HOME/.zsh/completions/_brew" ]]; then
        echo "‚úÖ Homebrew completion linked"
    else
        echo "‚ö†Ô∏è  Homebrew completion not linked"
    fi
else
    echo "‚ùå Homebrew completions directory missing"
fi

if [[ -f "$HOME/.zshrc.macos" ]]; then
    echo "‚úÖ macOS-specific safe compinit configuration created"
else
    echo "‚ùå macOS-specific safe compinit configuration missing"
fi

# Check fpath setup
if [[ -f "$HOME/.zshrc" ]] && grep -q "source.*zshrc.macos" "$HOME/.zshrc"; then
    echo "‚úÖ macOS config loaded in .zshrc"
else
    echo "‚ö†Ô∏è  macOS config not loaded in .zshrc"
fi
{{- end }}

echo "üí° Run 'exec zsh' to start using your new configuration"
echo "üí° If you still get errors, try: source ~/.zshrc"
echo "üí° For WSL users: The safe compinit config should prevent completion errors"
